# Caddy for Remnawave

## Что это такое?

Готовое решение для быстрого разворачивания Caddy в качестве обратного прокси для Remnawave панели и маскировки Remnawave нод c помощью своего сайта-заглушки на личном домене.

## Особенности

- ✅ Четыре варианта установки под разные задачи
- ✅ Поддержка "selfsteal" для маскировки, никакихи yahoo.com в fallback
- ✅ Простая настройка через .env файл и удобное управление
- ✅ Нет нужды возиться с сертификатами - Caddy позаботится об этом за вас
- ✅ Быстрый запуск через Docker Compose

## Сравнение вариантов

| Вариант | Описание и назначение | Нода | Панель | Selfsteal |
|---------|------------------------|:----:|:------:|:---------:|
| 1️⃣ Panel-only | Обратный прокси только для панели | ❌ | ✅ | ❌ |
| 2️⃣ Selfsteal-for-node-only | Дополнительная нода с маскировкой | ✅ | ❌ | ✅ |
| 3️⃣ Multi-port | Панель и нода на одном сервере, на разных портах  | ✅ | ✅ | ✅ |
| 4️⃣ All-in-one-port | Панель и нода на одном сервере на порту 443 | ✅ | ✅ | ✅ |
| 5️⃣ All-in-one-domain | Панель, нода и selfsteal на одном сервере и одном домене с защитой по cookie | ✅ | ✅ | ✅ |

## Требования
- В варианте 1 - установленная Remnawave панель
- В варианте 2 - установленная Remnawave нода
- В вариантах 3 и 4 - установленная Remnawave панель и нода
- Docker и Docker Compose
- Домен/домены с DNS записью, указывающей на ip вашей машины
- Минимум 1 ГБ RAM для ноды, для вариантов с панелью рекомендуется 2 ГБ RAM

## Общие шаги

```bash
git clone https://github.com/xxphantom/caddy-for-remnawave.git
cd caddy-for-remnawave
```

# Ставим зависимости (для make команд управления)

```bash
apt update && apt install -y make
```

## Конфигурации

### 1. Panel-only (только панель, ноды отдельно на других машинах)

**Для:** доступа к панели Remnawave и подпискам

```
Клиент → 443 порт → Caddy → Панель/Подписки (в зависимости от SNI) 
```

**Настройка:**
```bash
cd panel-only
cp .env.sample .env
nano .env  # Укажите домены для панели и подписок
```

**Запуск:**

```bash
make start
```

### 2. Selfsteal-for-node-only (только сайт заглушка для ноды, панель на другой машине)

**Для:** маскировки дополнительных нод

```
Клиент → 443 порт → Xray → (Прокси-соединения)
                      ↓
                     Caddy → Selfsteal сайт
```

**Настройка:**
```bash
cd selfsteal-for-node-only
cp .env.sample .env
nano .env  # Укажите SELFSTEAL_DOMAIN
```

**Запуск:**

```bash
make start
```

### 3. Multi-port (Панель и нода на разных портах но на одной машине)

**Для:** cервера с панелью и нодой.

В этой конфигурации панель и подписки запускаются на кастомных портах, а Xray на 443 порту. Также предоставляется selfsteal заглушка, В конфиге Xray в панели указать inbounds -> port 443, а streamSettings.dest должен указывать на порт локальной selfsteal заглушки. В поле serverNames должен быть указан домен selfsteal заглушки.

```
Клиент → 443 порт → Xray → (Прокси-соединения)
                      ↓
                     Caddy → Selfsteal сайт
Клиент → Кастомный порт Caddy → Панель/Подписки (в зависимости от SNI) 
```

**Настройка:**
```bash
cd multi-port
cp .env.sample .env
nano .env  # Укажите домены и порты

# Потом в панели Remnawave настройте inbound Xray:
# - port: 443
# - streamSettings.dest: порт как в SELF_STEAL_PORT
# - serverNames: как в SELFSTEAL_DOMAIN
```

**Запуск:**

```bash
make start
```

### 4. All-in-one-port (Всё на одном порту)

**Для:** панели и ноды на одной машине, но наружу не торчат лишние порты (в этом режиме доступность панели зависит от доступности ноды)

В этой конфигурации Remnawave нода (Xray в ней) обрабатывает весь входящий трафик на 443 порту. Все запросы, которые не являются Xray-proxy-соединениями уходят в dest fallback и перенаправляются в Caddy, который затем распределяет их по нужным сервисам (панель, selfsteal, подписки в зависимости от sni). Если в этом режиме остановить локальную Remnawave ноду, то панель перестанет быть доступна.

ВАЖНО! Для того, чтобы этот вариант конфигурации заработал, требуется сначала запустить панель на кастомном порту (третий вариант), установить и настроить локальную Remnawave ноду, в конфиге Xray в панели указать inbounds.port 443.

```
Клиент → 443 порт → Xray → (Прокси-соединения)
                      ↓
                     Caddy → Панель/Подписки/Selfsteal (в зависимости от SNI)
```

**Настройка:**
```bash
# Сначала настройте вариант 3, затем:
cd all-in-one-port
cp .env.sample .env
nano .env
```

**Запуск:**

```bash
make start
```

### 5. All-in-one-domain (Всё на одном домене)

**Для:** панели и ноды на одной машине и одном домене, с защитой панели на основе URL-параметра и cookie

В этой конфигурации Remnawave нода и панель используют один и тот же домен. Доступ к панели защищен с помощью секретного ключа, который передается через URL-параметр и сохраняется в cookie. Без правильного ключа пользователь увидит пустую страницу или ошибку 404, что делает панель невидимой для сканирования.

```
Клиент → Домен → Xray → (Прокси-соединения)
               ↓
              Caddy → Панель (если есть секретный ключ) 
                    → Selfsteal сайт (если нет секретного ключа)
                    → Подписки (если путь /sub)(если нет секретного ключа)
```

**Защита панели:**
- Для доступа к панели необходимо открыть страницу вида: `https://ВАШ_ДОМЕН/auth/login?caddy=<SECRET_KEY>`
- Параметр `?caddy=<SECRET_KEY>` устанавливает специальную Cookie `caddy=<SECRET_KEY>` в браузере
- Если Cookie не установлена или параметр в запросе отсутствует, пользователь увидит пустую страницу или ошибку 404
- Даже если злоумышленник будет сканировать хост или перебирать пути, без точного параметра и/или Cookie панель останется невидимой

**Настройка:**
```bash
cd all-in-one-domain-cookie
cp .env.sample .env
nano .env  # Укажите DOMAIN и PANEL_SECRET_KEY
```

**Запуск:**

```bash
make start
```

## Кастомизация selfsteal

Обязательно замените файлы в папке `html/` на свой сайт для маскировки - не плодите одинаковые заглушки

## Управление

```bash
make start    # Запуск
make stop     # Остановка
make restart  # Перезапуск
make logs     # Логи
```
Эти команды являются удобными алиасами для соответствующих docker-compose команд, можете посмотреть их в Makefile.

## FAQ

### Что такое "selfsteal"?
Максировка под свой же домен. Лучше максировка, скорость и надежность. 

### Какой вариант выбрать?
- Нужна панель, а ноды на других машинах → 1️⃣
- Нужна дополнительная нода → 2️⃣
- Нужна панель и ноды на одном сервере → 3️⃣ 
- Нужен вариант 3, но у вас аллергия на открытые порты → 4️⃣
- Нужен вариант c одним доменом и защитой панели по cookie → 5️⃣
